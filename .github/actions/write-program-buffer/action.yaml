name: "Write Program Buffer"
description: "Creates a buffer for the program binary"
inputs:
  program-id:
    description: "Program ID to check"
    required: true
  program:
    description: "Program name"
    required: true
  rpc-url:
    description: "Solana RPC URL"
    required: true
  keypair:
    description: "The keypair to use for buffer creation"
    required: true
  buffer-authority-address:
    description: "The buffer authority address. Could be the local address or the squads authority"
    required: true

outputs:
  buffer:
    description: "Created program buffer address"
    value: ${{ steps.write-buffer.outputs.buffer }}

runs:
  using: "composite"
  steps:
    - uses: ./.github/actions/setup/
    - uses: ./.github/actions/setup-solana/

    - name: Write keypair
      shell: bash
      run: echo "$DEPLOY_KEYPAIR" > ./deploy-keypair.json && chmod 600 ./deploy-keypair.json
      env:
        DEPLOY_KEYPAIR: ${{ inputs.keypair }}

    - name: Check if program exists
      id: check-program
      shell: bash
      run: |
        if solana program show ${{ inputs.program-id }} --url ${{ inputs.rpc-url }} 2>&1 | grep -q "Data Length:"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Program exists, will create buffer"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Program does not exist, skipping buffer creation"
        fi

    - name: Check program size
      id: check-size
      shell: bash
      run: |
        # Get current program size if it exists
        PROGRAM_INFO=$(solana program show ${{ inputs.program-id }} -u ${{ inputs.rpc-url }})
        if echo "$PROGRAM_INFO" | grep -q "Data Length:"; then
          # Extract size from format "Data Length: 212225 (0x33d01) bytes"
          CURRENT_SIZE=$(echo "$PROGRAM_INFO" | grep "Data Length:" | sed -E 's/.*Data Length: ([0-9]+).*/\1/')
          echo "Current program size: $CURRENT_SIZE bytes"
          
          NEW_SIZE=$(wc -c < ./target/deploy/${{ inputs.program }}.so)
          echo "New program size: $NEW_SIZE bytes"
          
          if [ $NEW_SIZE -gt $CURRENT_SIZE ]; then
            ADDITIONAL_BYTES=$((NEW_SIZE - CURRENT_SIZE))
            echo "Program needs to be extended by $ADDITIONAL_BYTES bytes"
            echo "needs_extend=true" >> $GITHUB_OUTPUT
            echo "additional_bytes=$ADDITIONAL_BYTES" >> $GITHUB_OUTPUT
          else
            echo "No extension needed"
            echo "needs_extend=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "Program not found, no extension needed"
          echo "needs_extend=false" >> $GITHUB_OUTPUT
        fi

    - name: Extend program
      if: steps.check-size.outputs.needs_extend == 'true'
      shell: bash
      run: |
        echo "Extending program by ${{ steps.check-size.outputs.additional_bytes }} bytes"
        solana program extend ${{ inputs.program-id }} \
          ${{ steps.check-size.outputs.additional_bytes }} \
          --keypair ./deploy-keypair.json \
          -u ${{ inputs.rpc-url }}

    - name: Write program buffer
      id: write-buffer
      if: steps.check-program.outputs.exists == 'true'
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 30
        max_attempts: 3
        shell: bash
        command: |
          echo "Creating program buffer... (Attempt $RETRY_ATTEMPT of 3)"
          OUTPUT=$(solana program write-buffer \
            ./target/deploy/${{ inputs.program }}.so \
            --url ${{ inputs.rpc-url }} \
            --keypair ./deploy-keypair.json \
            --max-sign-attempts 100 \
            --with-compute-unit-price 100000 \
            --use-rpc \
            2>&1)

          # Print output in real-time
          echo "$OUTPUT"

          # Check for success
          if ! echo "$OUTPUT" | grep -q "Buffer:"; then
            echo "Error: Buffer creation failed"
            exit 1
          fi

          # Extract buffer if successful
          BUFFER=$(echo "$OUTPUT" | grep "Buffer:" | cut -d " " -f2)
          if [ -z "$BUFFER" ]; then
            echo "Error: Could not extract buffer address"
            exit 1
          fi

          echo "Found buffer: $BUFFER"
          echo "buffer=$BUFFER" >> $GITHUB_OUTPUT

    # We can not set authority and upgrade program in the same instruction so it needs to be here
    # The rent for the buffer will be returned to the local keypair though. So its fine.
    # If the deploy fails you can also close the buffer with the multisig using the cli command squad-closebuffer
    - name: Transfer buffer authority
      if: steps.check-program.outputs.exists == 'true'
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 50
        shell: bash
        command: |
          BUFFER="${{ steps.write-buffer.outputs.buffer }}"
          echo "Transferring buffer authority for $BUFFER to ${{ inputs.buffer-authority-address }}"
          solana program set-buffer-authority $BUFFER \
            --keypair ./deploy-keypair.json \
            --new-buffer-authority ${{ inputs.buffer-authority-address }} \
            --url ${{ inputs.rpc-url }}

    - name: Cleanup
      if: always()
      shell: bash
      run: |
        rm -f ./deploy-keypair.json
        rm -f ./authority-keypair.json
